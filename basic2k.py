#!/root/Software/anaconda3/bin/python3
import numpy as np


def get_layer(filename, j):
	''' read data from an x-z plane, index j is 0-based '''
	nx, nz, ny = map(int, np.fromfile(filename, dtype=">f4", count=3))
	return np.fromfile(filename, dtype=">f4", count=nx*nz, offset=4*nx*nz*(j+1)).reshape([nz,nx])

def get_stream(filename, j, k):
	''' read data along an x line, indices j & k are 0-based '''
	nx, nz, ny = map(int, np.fromfile(filename, dtype=">f4", count=3))
	return np.fromfile(filename, dtype=">f4", count=nx, offset=4*nx*(nz*(j+1)+k)).ravel()


class DataSetInfo:
	def __init__(self, path):
		self.path = path
		self.fieldpath = path + 'fields/'

		self.tsteps1 = [204,273,288,339,399,471,498,597,    720,798,846,870,897,921,]
		self.tsteps2 = [204,273,        399,    498,597,699,                897,    ]
		self.tsteps3 = [204,273,288,339,399,    498,597,699,    798,            921,]
		self.tsteps = [t1 for t1 in self.tsteps1 if t1 in [t2 for t2 in self.tsteps2 if t2 in self.tsteps3]]


		self.Re = 48500.
		self.Ret = 2003.

		self.Lx = 8*np.pi
		self.Ly = 2.0
		self.Lz = 3*np.pi
		self.Nx = 6144
		self.Ny = 633
		self.Nz = 4608

		# mesh grids
		self.xs = np.arange(self.Nx) * self.Lx / self.Nx
		self.zs = np.arange(self.Nz) * self.Lz / self.Nz

		try:
			# when a ymesh file is available
			self.ys = np.loadtxt(self.path + 'ymesh2000.txt').ravel()
		except:
			# when the ymesh data is embedded in this code file
			ymesh = None
			for line in open(__file__):
				if line.find('# begin of ymesh2000.txt') == 0: ymesh = []
				elif line.find('# end of ymesh2000.txt') == 0: break
				elif ymesh is not None: ymesh.append(float(line.split('#')[-1]))
			self.ys = np.array(ymesh)


		self.dx = self.Lx / self.Nx
		self.dz = self.Lz / self.Nz
		self.dys = np.hstack([0, self.ys[1:]-self.ys[:-1]])

		self.kxs = np.fft.rfftfreq(self.Nx, d=self.dx/(2*np.pi))
		self.kzs = np.fft.rfftfreq(self.Nz, d=self.dz/(2*np.pi))

		# inner scales
		self.uc = self.Ret / self.Re
		self.lc = 1. / self.Ret
		self.tc = self.lc / self.uc
		self.pc = self.uc**2.

		self.xps = self.xs / self.lc
		self.yps = self.ys / self.lc
		self.zps = self.zs / self.lc



if __name__ == '__main__':
	''' 2 examples for accessing the raw data '''
	import matplotlib.pyplot as plt

	para = DataSetInfo('')

	fig, axs = plt.subplots(2, 1, sharex=True, tight_layout=True, figsize=(6.4,4.8))

	''' example 1: draw a u plane at y^+ = 15 '''
	data = get_layer(
		para.fieldpath + 'chan2000.%d.U'%para.tsteps[0],
		np.argmin(np.abs(para.yps-15)) )
	
	mean, std = np.mean(data), np.std(data)

	ax = axs[0]
	ax.contourf(para.xs, para.zs, data,
		levels = mean + np.linspace(-2*std, 2*std, 5),
		extend = 'both' )
	ax.set_ylabel('z')
	ax.set_title(r'$u (y^+ = 15)$')
	ax.axis('scaled')

	''' example 2: draw a u cut (x-z plane) '''
	data = np.array([ get_stream(
		para.fieldpath + 'chan2000.%d.U'%para.tsteps[0],
		j, para.Nz//2) for j in range(para.Ny) ])

	data.T[:] -= np.mean(data, axis=-1)

	ax = axs[1]
	ax.contourf(para.xs, para.ys, data,
		levels = np.linspace(-2*std, 2*std, 5),
		extend = 'both' )
	ax.set_xlabel('x')
	ax.set_ylabel('y')
	ax.set_title(r'$u$ (center cut)')
	ax.axis('scaled')


	fig.savefig('example.png', dpi=300)
	plt.close()



# begin of ymesh2000.txt
# 0.000000
# 0.000161
# 0.000383
# 0.000664
# 0.001002
# 0.001396
# 0.001843
# 0.002342
# 0.002892
# 0.003492
# 0.004140
# 0.004834
# 0.005574
# 0.006358
# 0.007186
# 0.008056
# 0.008967
# 0.009918
# 0.010909
# 0.011939
# 0.013006
# 0.014109
# 0.015249
# 0.016424
# 0.017634
# 0.018877
# 0.020154
# 0.021463
# 0.022804
# 0.024177
# 0.025580
# 0.027013
# 0.028476
# 0.029968
# 0.031488
# 0.033037
# 0.034613
# 0.036217
# 0.037847
# 0.039504
# 0.041186
# 0.042894
# 0.044626
# 0.046384
# 0.048166
# 0.049972
# 0.051801
# 0.053654
# 0.055530
# 0.057428
# 0.059349
# 0.061291
# 0.063255
# 0.065241
# 0.067248
# 0.069276
# 0.071324
# 0.073393
# 0.075482
# 0.077591
# 0.079719
# 0.081867
# 0.084033
# 0.086219
# 0.088424
# 0.090647
# 0.092888
# 0.095147
# 0.097425
# 0.099720
# 0.102032
# 0.104362
# 0.106709
# 0.109073
# 0.111454
# 0.113851
# 0.116265
# 0.118695
# 0.121142
# 0.123604
# 0.126082
# 0.128576
# 0.131085
# 0.133610
# 0.136150
# 0.138705
# 0.141276
# 0.143861
# 0.146461
# 0.149075
# 0.151704
# 0.154347
# 0.157005
# 0.159676
# 0.162362
# 0.165062
# 0.167775
# 0.170502
# 0.173243
# 0.175997
# 0.178764
# 0.181545
# 0.184339
# 0.187146
# 0.189966
# 0.192799
# 0.195645
# 0.198503
# 0.201374
# 0.204258
# 0.207154
# 0.210062
# 0.212983
# 0.215916
# 0.218861
# 0.221818
# 0.224787
# 0.227768
# 0.230761
# 0.233765
# 0.236782
# 0.239809
# 0.242849
# 0.245900
# 0.248962
# 0.252035
# 0.255120
# 0.258216
# 0.261324
# 0.264442
# 0.267571
# 0.270712
# 0.273863
# 0.277025
# 0.280198
# 0.283382
# 0.286576
# 0.289781
# 0.292996
# 0.296223
# 0.299459
# 0.302706
# 0.305963
# 0.309231
# 0.312509
# 0.315798
# 0.319096
# 0.322405
# 0.325723
# 0.329052
# 0.332391
# 0.335740
# 0.339098
# 0.342467
# 0.345846
# 0.349234
# 0.352632
# 0.356040
# 0.359457
# 0.362885
# 0.366321
# 0.369768
# 0.373224
# 0.376689
# 0.380164
# 0.383649
# 0.387143
# 0.390646
# 0.394159
# 0.397681
# 0.401212
# 0.404753
# 0.408303
# 0.411862
# 0.415430
# 0.419007
# 0.422594
# 0.426190
# 0.429794
# 0.433408
# 0.437031
# 0.440663
# 0.444304
# 0.447954
# 0.451612
# 0.455280
# 0.458957
# 0.462642
# 0.466336
# 0.470039
# 0.473751
# 0.477472
# 0.481201
# 0.484939
# 0.488686
# 0.492442
# 0.496206
# 0.499979
# 0.503760
# 0.507550
# 0.511349
# 0.515156
# 0.518972
# 0.522797
# 0.526630
# 0.530471
# 0.534321
# 0.538179
# 0.542046
# 0.545921
# 0.549805
# 0.553697
# 0.557597
# 0.561506
# 0.565423
# 0.569348
# 0.573282
# 0.577224
# 0.581174
# 0.585133
# 0.589099
# 0.593074
# 0.597057
# 0.601048
# 0.605047
# 0.609055
# 0.613070
# 0.617093
# 0.621125
# 0.625164
# 0.629212
# 0.633267
# 0.637331
# 0.641402
# 0.645481
# 0.649568
# 0.653662
# 0.657765
# 0.661875
# 0.665993
# 0.670118
# 0.674252
# 0.678392
# 0.682541
# 0.686696
# 0.690860
# 0.695030
# 0.699208
# 0.703394
# 0.707586
# 0.711786
# 0.715993
# 0.720207
# 0.724428
# 0.728656
# 0.732891
# 0.737133
# 0.741381
# 0.745637
# 0.749899
# 0.754167
# 0.758442
# 0.762723
# 0.767011
# 0.771304
# 0.775604
# 0.779910
# 0.784222
# 0.788539
# 0.792863
# 0.797192
# 0.801526
# 0.805866
# 0.810211
# 0.814561
# 0.818916
# 0.823276
# 0.827640
# 0.832010
# 0.836383
# 0.840761
# 0.845144
# 0.849530
# 0.853920
# 0.858314
# 0.862711
# 0.867112
# 0.871516
# 0.875923
# 0.880334
# 0.884747
# 0.889162
# 0.893580
# 0.898001
# 0.902423
# 0.906848
# 0.911274
# 0.915702
# 0.920132
# 0.924563
# 0.928996
# 0.933429
# 0.937864
# 0.942299
# 0.946736
# 0.951173
# 0.955610
# 0.960048
# 0.964487
# 0.968925
# 0.973364
# 0.977803
# 0.982243
# 0.986682
# 0.991121
# 0.995561
# 1.000000
# 1.004439
# 1.008879
# 1.013318
# 1.017757
# 1.022197
# 1.026636
# 1.031075
# 1.035513
# 1.039952
# 1.044390
# 1.048827
# 1.053264
# 1.057701
# 1.062136
# 1.066571
# 1.071004
# 1.075437
# 1.079868
# 1.084298
# 1.088726
# 1.093152
# 1.097577
# 1.101999
# 1.106420
# 1.110838
# 1.115253
# 1.119666
# 1.124077
# 1.128484
# 1.132888
# 1.137289
# 1.141686
# 1.146080
# 1.150470
# 1.154856
# 1.159239
# 1.163617
# 1.167990
# 1.172360
# 1.176724
# 1.181084
# 1.185439
# 1.189789
# 1.194134
# 1.198474
# 1.202808
# 1.207137
# 1.211461
# 1.215778
# 1.220090
# 1.224396
# 1.228696
# 1.232989
# 1.237277
# 1.241558
# 1.245833
# 1.250101
# 1.254363
# 1.258619
# 1.262867
# 1.267109
# 1.271344
# 1.275572
# 1.279793
# 1.284007
# 1.288214
# 1.292414
# 1.296606
# 1.300792
# 1.304970
# 1.309140
# 1.313304
# 1.317459
# 1.321608
# 1.325748
# 1.329882
# 1.334007
# 1.338125
# 1.342235
# 1.346338
# 1.350432
# 1.354519
# 1.358598
# 1.362669
# 1.366733
# 1.370788
# 1.374836
# 1.378875
# 1.382907
# 1.386930
# 1.390945
# 1.394953
# 1.398952
# 1.402943
# 1.406926
# 1.410901
# 1.414867
# 1.418826
# 1.422776
# 1.426718
# 1.430652
# 1.434577
# 1.438494
# 1.442403
# 1.446303
# 1.450195
# 1.454079
# 1.457954
# 1.461821
# 1.465679
# 1.469529
# 1.473370
# 1.477203
# 1.481028
# 1.484844
# 1.488651
# 1.492450
# 1.496240
# 1.500021
# 1.503794
# 1.507558
# 1.511314
# 1.515061
# 1.518799
# 1.522528
# 1.526249
# 1.529961
# 1.533664
# 1.537358
# 1.541043
# 1.544720
# 1.548388
# 1.552046
# 1.555696
# 1.559337
# 1.562969
# 1.566592
# 1.570206
# 1.573810
# 1.577406
# 1.580993
# 1.584570
# 1.588138
# 1.591697
# 1.595247
# 1.598788
# 1.602319
# 1.605841
# 1.609354
# 1.612857
# 1.616351
# 1.619836
# 1.623311
# 1.626776
# 1.630232
# 1.633679
# 1.637115
# 1.640543
# 1.643960
# 1.647368
# 1.650766
# 1.654154
# 1.657533
# 1.660902
# 1.664260
# 1.667609
# 1.670948
# 1.674277
# 1.677595
# 1.680904
# 1.684202
# 1.687491
# 1.690769
# 1.694037
# 1.697294
# 1.700541
# 1.703777
# 1.707004
# 1.710219
# 1.713424
# 1.716618
# 1.719802
# 1.722975
# 1.726137
# 1.729288
# 1.732429
# 1.735558
# 1.738676
# 1.741784
# 1.744880
# 1.747965
# 1.751038
# 1.754100
# 1.757151
# 1.760191
# 1.763218
# 1.766235
# 1.769239
# 1.772232
# 1.775213
# 1.778182
# 1.781139
# 1.784084
# 1.787017
# 1.789938
# 1.792846
# 1.795742
# 1.798626
# 1.801497
# 1.804355
# 1.807201
# 1.810034
# 1.812854
# 1.815661
# 1.818455
# 1.821236
# 1.824003
# 1.826757
# 1.829498
# 1.832225
# 1.834938
# 1.837638
# 1.840324
# 1.842995
# 1.845653
# 1.848296
# 1.850925
# 1.853539
# 1.856139
# 1.858724
# 1.861295
# 1.863850
# 1.866390
# 1.868915
# 1.871424
# 1.873918
# 1.876396
# 1.878858
# 1.881305
# 1.883735
# 1.886149
# 1.888546
# 1.890927
# 1.893291
# 1.895638
# 1.897968
# 1.900280
# 1.902575
# 1.904853
# 1.907112
# 1.909353
# 1.911576
# 1.913781
# 1.915967
# 1.918133
# 1.920281
# 1.922409
# 1.924518
# 1.926607
# 1.928676
# 1.930724
# 1.932752
# 1.934759
# 1.936745
# 1.938709
# 1.940651
# 1.942572
# 1.944470
# 1.946346
# 1.948199
# 1.950028
# 1.951834
# 1.953616
# 1.955374
# 1.957106
# 1.958814
# 1.960496
# 1.962153
# 1.963783
# 1.965387
# 1.966963
# 1.968512
# 1.970032
# 1.971524
# 1.972987
# 1.974420
# 1.975823
# 1.977196
# 1.978537
# 1.979846
# 1.981123
# 1.982366
# 1.983576
# 1.984751
# 1.985891
# 1.986994
# 1.988061
# 1.989091
# 1.990082
# 1.991033
# 1.991944
# 1.992814
# 1.993642
# 1.994426
# 1.995166
# 1.995860
# 1.996508
# 1.997108
# 1.997658
# 1.998157
# 1.998604
# 1.998998
# 1.999336
# 1.999617
# 1.999839
# 2.000000
# end of ymesh2000.txt
